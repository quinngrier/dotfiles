#
# This file (~/.bashrc-bottom) holds the code that should be put at the
# bottom of the ~/.bashrc file. The following command can be put at the
# bottom of the ~/.bashrc file to do this indirectly:
#
#       . ~/.bashrc-bottom
#
# The reason for not putting the code directly into the ~/.bashrc file
# is to make it easier to work with default ~/.bashrc files on systems
# that provide them. It is easier to make this file portable and make
# the above small change on each system than it is to make a portable
# ~/.bashrc file that reasonably subsumes all default ~/.bashrc files.
#
# Note that the master copy of the default ~/.bashrc file can sometimes
# be found at one of the following locations:
#
#       /etc/skel/.bashrc
#

#
# Set the prompt string and window title.
#
# The prompt string looks like this:
#
#       [0][user@host:/current/working/directory]
#       $
#
# The "[0]" part is the exit status of the last command. If the command
# was a pipeline, then the exit status of every command in the pipeline
# will appear, separated by spaces. For example, "true | false | false"
# yields "[0 1 1]". The first line of the prompt string is colored all
# the way to the edge of the window for visual distinction.
#
# The window title looks like this:
#
#       user@host:/current/working/directory
#

PS1='\[\e[0m\]\[\e]0;\u@\H:\w\a\]\[\e[37;44m\]\[\e[K\]'
PS1=$PS1'[${PIPESTATUS[@]}][\u@\H:\w]\[\e[0m\]\n\$ '

#
# Set up gpg-agent and ssh-agent.
#

eval $(

  set -euo pipefail || exit 1

  uname=$(uname)
  readonly uname

  case $uname in
    (*CYGWIN*)
      boot=$(WMIC OS GET LastBootUpTime | tr -d '\r ' | sed -n 2p)
    ;;
    (*)
      boot=$(who -b | sed 's/.*boot//')
      boot=$(date -d "$boot" +%s)
    ;;
  esac
  readonly boot

  inherit_or_start() {
    if [[ ! -f $1-$boot ]]; then
      rm -f $1-* || :
      $2 >$1-$boot
    fi
    echo . $1-$boot \;
  }

  inherit_or_start ~/.bashrc-gpg-agent 'gpg-agent --daemon' || :
  inherit_or_start ~/.bashrc-ssh-agent 'ssh-agent' || :

)

GPG_TTY=$(tty)
export GPG_TTY

#
# The authors of this file have waived all copyright and
# related or neighboring rights to the extent permitted by
# law as described by the CC0 1.0 Universal Public Domain
# Dedication. You should have received a copy of the full
# dedication along with this file, typically as a file
# named <CC0-1.0.txt>. If not, it may be available at
# <https://creativecommons.org/publicdomain/zero/1.0/>.
#
