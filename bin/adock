#! /bin/sh -
#
# The authors of this file have waived all copyright and
# related or neighboring rights to the extent permitted by
# law as described by the CC0 1.0 Universal Public Domain
# Dedication. You should have received a copy of the full
# dedication along with this file, typically as a file
# named <CC0-1.0.txt>. If not, it may be available at
# <https://creativecommons.org/publicdomain/zero/1.0/>.
#
# Usage: adock [<arg>]...
#
# Runs a quinngrier/adock Docker container with the given arguments. The
# current working directory will be mounted into and used as the current
# working directory in the container so that all files below the current
# working directory are accessible. The container will use the current
# user ID and group ID so that any files it outputs will have the
# appropriate ownership.
#
# See <https://github.com/quinngrier/adock> for more information about
# the quinngrier/adock image.
#
# You can change the docker command by setting the DOCKER_COMMAND
# environment variable. The value will be evaluated by the shell.
#
# You can change the Docker image by setting the ADOCK_IMAGE environment
# variable.
#
# You can force the newest Docker image to be pulled by setting the
# ADOCK_PULL environment variable to any nonempty value.
#
# Example 1. Compile README.adoc into README.html.
#
#       adock README.adoc
#
# Example 2. Compile README.adoc into README.pdf.
#
#       adock -r asciidoctor-pdf -b pdf README.adoc
#
# Example 3. Compile README.adoc into README.html, running docker with
# sudo.
#
#       DOCKER_COMMAND='sudo docker' adock README.adoc
#

LC_ALL=C
readonly LC_ALL
export LC_ALL

docker=${DOCKER_COMMAND:-docker}
readonly docker

image=${ADOCK_IMAGE:-quinngrier/adock}
readonly image

[ -t 0 ] && t=-t || t=
u=`id -u` || exit $?
g=`id -g` || exit $?
pwd=`pwd` || exit $?

if ${ADOCK_PULL:+:} false; then
  eval " $docker"' pull "$image"' || exit $?
fi

args='run --rm -i $t -u $u:$g -v "$pwd":/x -w /x "$image"'
case $# in
  0)
    eval " $docker $args"
    exit $?
  ;;
  *)
    eval " $docker $args"' "$@"'
    exit $?
  ;;
esac
