#! /bin/sh -
#
# The authors of this file have waived all copyright and
# related or neighboring rights to the extent permitted by
# law as described by the CC0 1.0 Universal Public Domain
# Dedication. You should have received a copy of the full
# dedication along with this file, typically as a file
# named <CC0-1.0.txt>. If not, it may be available at
# <https://creativecommons.org/publicdomain/zero/1.0/>.
#

export LC_ALL=C

case $#,$1 in
  1,--help)
    cat <<'EOF' || exit $?
Usage: gpgsec <name> [<value>]

Manages GPG-encrypted secrets in the ~/.gpgsec directory.

If <value> is nonempty, it will be encrypted and written to the
~/.gpgsec/<name>.gpg file. Otherwise, if <value> is empty, the file will
be deleted. Otherwise, if <value> is omitted, the file will be decrypted
and written to standard output.

<name> may freely contain directory components, allowing secrets to be
organized into directories. For tab completion convenience, <name> may
optionally be prefixed with "~/.gpgsec/" and suffixed with ".gpg".

If <value> is "-", it will be read from standard input.

gpg2 must already be installed and a default-key must already be set up
in the ~/.gnupg/gpg.conf file. The --default-recipient-self option will
be used when encrypting.
EOF
    exit 0
  ;;
  [1-2],*)
    :
  ;;
  *)
    cat <<'EOF' >&2
gpgsec: bad usage, try "gpgsec --help"
EOF
    exit 1
  ;;
esac

name=$1
readonly name

case $name in
  .. | ../* | */../* | */..)
    cat <<'EOF' >&2
gpgsec: invalid <name>
EOF
    exit 1
  ;;
esac

file=$name
case $file in
  "$HOME"/.gpgsec/*)
    :
  ;;
  *)
    file=$HOME/.gpgsec/$file
  ;;
esac
case $file in
  *.gpg)
    :
  ;;
  *)
    file=$file.gpg
  ;;
esac
readonly file

case $# in
  1)
    gpg2 -q -d <"$file"
    exit $?
  ;;
esac

value=$2
readonly value

case $value in
  '')
    if command -v shred >/dev/null; then
      shred "$file"
    fi
    rm -f "$file"
    exit $?
  ;;
esac

umask 077 || exit $?

if test -f "$file"; then
  :
else
  mkdir -p "$file" || exit $?
  rmdir "$file" || exit $?
fi

case $value in
  -)
    gpg2 -q -a --default-recipient-self -e -s >"$file"
    exit $?
  ;;
  *)
    gpg2 -q -a --default-recipient-self -e -s >"$file" <<EOF
$value
EOF
    exit $?
  ;;
esac
