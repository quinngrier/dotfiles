#! /bin/sh -
#
# The authors of this file have waived all copyright and
# related or neighboring rights to the extent permitted by
# law as described by the CC0 1.0 Universal Public Domain
# Dedication. You should have received a copy of the full
# dedication along with this file, typically as a file
# named <CC0-1.0.txt>. If not, it may be available at
# <https://creativecommons.org/publicdomain/zero/1.0/>.
#

real_host=${1?}
readonly real_host
shift

host=${1?}
readonly host
shift

port=${1?}
readonly port
shift

user=${1?}
readonly user
shift

unset key_content

finish() {
  case ${key_content+x} in ?*)
    ssh-add -t 10 -q - <<EOF || :
${key_content?}
EOF
  esac
  exec nc "${real_host?}" "${port?}" || exit $?
}

check_for_file() {
  eval ${2?}=:
  test -f "${1?}" || {
    check_for_file_status=$?
    case ${check_for_file_status?} in 1)
      eval ${2?}=false
    ;; *)
      exit ${check_for_file_status?}
    esac
  }
  readonly ${2?}
}

check_for_program() {
  eval ${2?}=:
  command -v "${1?}" >/dev/null || {
    check_for_program_status=$?
    case ${check_for_program_status?} in 1)
      eval ${2?}=false
    ;; *)
      exit ${check_for_program_status?}
    esac
  }
  readonly ${2?}
}

#-----------------------------------------------------------------------
#
# If we don't have ssh-add, there's nothing we can do.
#

check_for_program ssh-add have_ssh_add

if ${have_ssh_add?}; then
  :
else
  finish
fi

#-----------------------------------------------------------------------
# gpgsec
#-----------------------------------------------------------------------

check_for_program gpgsec have_gpgsec

if ${have_gpgsec?}; then

  gpgsec_entry=ssh-autokey/${host?}/${user?}
  readonly gpgsec_entry

  # TODO: gpgsec should have an option to check for entry existence.
  check_for_file ~/.gpgsec/"${gpgsec_entry?}".gpg have_gpgsec_entry

  if ${have_gpgsec_entry?}; then
    key_content=`gpgsec -- "${gpgsec_entry?}"` || exit $?
    readonly key_content
    finish
  fi

fi

#-----------------------------------------------------------------------

finish
